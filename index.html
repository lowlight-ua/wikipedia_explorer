<!DOCTYPE html>
<html>
<head>
<style>
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>

'use strict';

let appl = {};

// ----------------------------------------------------------------------------

class JSONSet extends Set {
    toJSON () {
        return [...this]
    }
}

// ----------------------------------------------------------------------------

class Graph
{
    constructor()
    {
        this.linksOut = {};
        this.linksIn = {};
        this.searchOut = {};
        this.centerArticle = "";
    }

    addLink(from, to)
    {
        if (!(from in this.linksOut))
        {
            this.linksOut[from] = new JSONSet();
        }
        this.linksOut[from].add(to);

        if (!(to in this.linksIn))
        {
            this.linksIn[to] = new JSONSet();
        }
        this.linksIn[to].add(from);
    }

    addSearchOut(term, results)
    {
	    if (!(term in this.searchOut))
        {
            this.searchOut[term] = new JSONSet();
        }	
        this.searchOut[term].add(results);
    }
}

// ----------------------------------------------------------------------------

class Application
{
    constructor()
    {
        this.graph = new Graph();
        this.steps = 3;
    }

    gotWikiLinks(data)
    {
        const dqp = data.query.pages;
        const links = dqp[Object.keys(dqp)[0]].links;
        let graph = this.graph;
        const titles = links.forEach(x => graph.addLink(graph.centerArticle, x.title));
        this.onStepComplete();
    }

    gotWikiBacklinks(data)
    {
        const dqp = data.query.pages;
        const linkshere = dqp[Object.keys(dqp)[0]].linkshere;
        let graph = this.graph;
        const titles = linkshere.forEach(x => graph.addLink(x.title, graph.centerArticle));
        this.onStepComplete();
    }

    gotWikiSearchResult(data)
    {
        const dqs = data.query.search;
        let graph = this.graph;
        const titles = dqs.forEach(x => graph.addSearchOut(graph.centerArticle, x.title));
        this.onStepComplete();
    }

    onStepComplete()
    {
        this.steps--;
        if (this.steps == 0)
        {
            this.onOperationComplete();
        }
    }

    onOperationComplete()
    {
        const related = [];
        const graph = this.graph;
        const linksOut =  graph.linksOut[graph.centerArticle];
        const linksIn  =  graph.linksIn[graph.centerArticle];            
        const searchOut  =  graph.searchOut[graph.centerArticle];

        for (var it = linksOut.values(), val= null; val=it.next().value; ) 
        {
            const linkRank = linksIn.has(val) + linksIn.has(val) + searchOut.has(val);
            if (!related[linkRank])
            {
                related[linkRank] = [];
            }
            related[linkRank].push(val);
        }

        for(let i=related.length - 1; i >= 0; i--)
        {
            const articles = related[i];
            for(let j=0; j < articles.length; j++)
            {
                $("#json_out").append(i + "   " + related[i][j] + "\n");
            }
        }
    }
}

// ----------------------------------------------------------------------------

function onGoClick()
{
    appl = new Application(); 
    let graph = appl.graph;

    let thePage = $("#pagetitle").val();
    if (thePage.length == 0)
    {
        return;
    }
    graph.centerArticle = thePage;

    $.ajax( {
        url: 'https://en.wikipedia.org/w/api.php',
        data: {
            action: 'query',
            prop: 'links',
            format: 'json',
            titles: thePage,
            plnamespace: 0,
            origin: '*',
            pllimit: 'max'
        },
        xhrFields: {
            withCredentials: false
        },
        dataType: 'json'
    } ).done(function(data) { appl.gotWikiLinks(data); });

    $.ajax( {
        url: 'https://en.wikipedia.org/w/api.php',
        data: {
            action: 'query',
            prop: 'linkshere',
            titles: thePage,
            format: 'json',
            lhnamespace: 0,
            origin: '*',
            lhlimit: 'max'
        },
        xhrFields: {
            withCredentials: false
        },
        dataType: 'json'
    } ).done(function(data) { appl.gotWikiBacklinks(data); });  

    $.ajax( {
        url: 'https://en.wikipedia.org/w/api.php',
        data: {
            action: 'query',
            list: 'search',
            srsearch: thePage,
            format: 'json',
            formatversion: 2,
            origin: '*',
            srlimit: 25
        },
        xhrFields: {
            withCredentials: false
        },
        dataType: 'json'
    } ).done(function(data) { appl.gotWikiSearchResult(data); });  
}

// ----------------------------------------------------------------------------

$(document).ready(function()
{    
    $("#gobutton").click(onGoClick);
});

</script>

</head>

<body>

<input type="text" id="pagetitle"><br>
<input type="button" id="gobutton" value="GO">

<div id="output">
    <pre id="json_out">
        NOTHING HERE
    </pre>
</div>

</body>

</html>
